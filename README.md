# DMM Go Task - 認証認可・会員基盤・不正対策システム

このプロジェクトは、Go言語とGinフレームワークを使用して構築された包括的なAPIサービスです。認証認可、会員基盤、不正対策システムを統合したセキュアなプラットフォームを提供します。

## 🚀 主要機能

### 認証認可システム

- **JWT認証**: アクセストークンとリフレッシュトークンによる認証
- **ロールベースアクセス制御**: 管理者、ユーザー、モデレーターの権限管理
- **パスワード暗号化**: bcryptによる安全なパスワードハッシュ化
- **セッション管理**: ユーザーセッションの追跡と管理

### 会員基盤システム

- **会員ランク制度**: Bronze、Silver、Gold、Platinumの4段階
- **ポイントシステム**: ポイントの獲得、使用、有効期限管理
- **ユーザープロフィール**: 詳細なユーザー情報管理
- **通知システム**: ユーザーへの通知配信
- **設定管理**: ユーザー個別設定の保存

### 不正対策システム

- **リアルタイム不正検知**: ログイン試行の分析とリスク評価
- **IPブラックリスト**: 悪意のあるIPアドレスの自動ブロック
- **レート制限**: API呼び出し頻度の制限
- **デバイスフィンガープリンティング**: デバイス識別による不正検知
- **セキュリティイベントログ**: 全セキュリティ関連イベントの記録

## 🛠️ 技術スタック

- **言語**: Go
- **フレームワーク**: Gin (HTTP)
- **ORM**: GORM
- **データベース**: MySQL
- **認証**: JWT
- **アーキテクチャパターン**: DDD + レイヤードアーキテクチャ

## 📁 プロジェクト構造

```bash
internal/
├── application/           # アプリケーション層
│   ├── dto/              # データ転送オブジェクト
│   └── handler/          # HTTPハンドラー
├── domain/               # ドメイン層
│   ├── entity/           # エンティティ
│   ├── repository/       # リポジトリインターフェース
│   └── service/          # ドメインサービス
├── infrastructure/       # インフラ層
│   └── persistence/      # データ永続化
└── usecase/              # ユースケース層
```

## 🚀 セットアップ

### 1. 環境変数の設定

```bash
cp .env.example .env
```

`.env`ファイルを編集して、データベース接続情報やJWTシークレットを設定してください。

### 2. 依存関係のインストール

```bash
go mod download
```

### 4. アプリケーションの起動

```bash
task run
```

## 📚 API エンドポイント

### 認証API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | `/api/v1/auth/register` | ユーザー登録 |
| POST | `/api/v1/auth/login` | ログイン |
| POST | `/api/v1/auth/refresh` | トークンリフレッシュ |
| POST | `/api/v1/auth/validate` | トークン検証 |

### ユーザーAPI（認証必須）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | `/api/v1/user/logout` | ログアウト |
| GET | `/api/v1/user/profile` | プロフィール取得 |
| PUT | `/api/v1/user/profile` | プロフィール更新 |
| GET | `/api/v1/user/dashboard` | ダッシュボード |
| GET | `/api/v1/user/notifications` | 通知一覧 |
| GET | `/api/v1/user/points/transactions` | ポイント履歴 |

### 管理者API（管理者権限必須）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | `/api/v1/admin/stats/membership` | 会員統計 |
| GET | `/api/v1/admin/stats/fraud` | 不正検知統計 |
| GET | `/api/v1/admin/security/events` | セキュリティイベント |
| POST | `/api/v1/admin/security/blacklist` | IPブラックリスト追加 |
| GET | `/api/v1/admin/users` | 全ユーザー一覧 |

## 🔒 セキュリティ機能

### 不正検知アルゴリズム

システムは以下の要素を分析してリスクスコアを算出します：

- **ログイン頻度**: 短時間での大量ログイン試行
- **失敗率**: ログイン失敗の割合
- **IP評価**: IPアドレスの過去の行動履歴
- **User-Agent分析**: 疑わしいUser-Agentパターン
- **地理的異常**: 通常と異なる地域からのアクセス

### レート制限

デフォルトのレート制限設定：

- **ログイン**: 5回/5分
- **登録**: 3回/1時間
- **一般API**: 100回/1分

### セキュリティイベント

以下のイベントが自動的に記録されます：

- ログイン成功/失敗
- 不正なアクセス試行
- 権限昇格の試み
- IPブラックリスト操作
- 管理者操作

## 🧪 テスト

### 単体テスト

```bash
task test:unit
```

### E2Eテスト

```bash
task test:e2e
```

## 📊 監視とログ

### ヘルスチェック

```bash
curl http://localhost/health
```

### システム統計

管理者権限で以下のエンドポイントから統計情報を取得できます：

- `/api/v1/admin/stats/membership` - 会員統計
- `/api/v1/admin/stats/fraud` - 不正検知統計
- `/api/v1/admin/health` - システムヘルス

## 🔧 設定

### 環境変数

主要な環境変数：

- `JWT_SECRET`: JWT署名用シークレットキー
- `DATABASE_*`: データベース接続情報
- `ENABLE_FRAUD_DETECTION`: 不正検知機能の有効/無効
- `MAX_LOGIN_ATTEMPTS`: 最大ログイン試行回数

### 会員ランク設定

会員ランクは以下の基準で自動昇格されます：

- **Bronze**: 初期ランク
- **Silver**: 累計支出10,000円 または 1,000ポイント
- **Gold**: 累計支出50,000円 または 5,000ポイント
- **Platinum**: 累計支出100,000円 または 10,000ポイント

## 🚀 本番環境デプロイ

### Docker使用

```bash
docker-compose up -d
```

### 本番環境設定

1. `JWT_SECRET`を強力なランダム文字列に変更
2. `GIN_MODE=release`に設定
3. データベース接続情報を本番環境用に更新
4. HTTPS証明書の設定
5. ログレベルを`warn`または`error`に設定

## 📝 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🤝 コントリビューション

1. このリポジトリをフォーク
2. 機能ブランチを作成 (`git checkout -b feature/amazing-feature`)
3. 変更をコミット (`git commit -m 'Add amazing feature'`)
4. ブランチにプッシュ (`git push origin feature/amazing-feature`)
5. プルリクエストを作成

## 📞 サポート

質問や問題がある場合は、GitHubのIssuesページでお知らせください。

---

**注意**: このシステムは本格的なセキュリティ機能を含んでいますが、本番環境で使用する前に十分なセキュリティ監査を実施することを強く推奨します。
