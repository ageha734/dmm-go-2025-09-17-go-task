version: "3"

output: prefixed

dotenv: [".env"]

vars:
  E2E_TEST_NAME:
    sh: find ./e2e -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | sort | uniq

tasks:
  default:
    silent: true
    desc: "åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™"
    cmds:
      - task --list-all

  # --------------------------------------------------------------------------
  # Setup Tasks
  # --------------------------------------------------------------------------

  :setup:mysql:macos:
    internal: true
    prefix: "ğŸ”§"
    platforms:
    - darwin
    status:
      - command -v mysql >/dev/null 2>&1
    cmds:
      - brew install mysql-client

  :setup:mysql:linux:
    internal: true
    prefix: "ğŸ”§"
    platforms:
    - linux
    status:
      - command -v mysql >/dev/null 2>&1
    cmds:
      - task: :setup:mysql:linux:apt
      - task: :setup:mysql:linux:yum
      - task: :setup:mysql:linux:dnf
      - task: :setup:mysql:linux:pacman
      - task: :setup:mysql:linux:zypper

  :setup:mysql:linux:apt:
    internal: true
    prefix: "ğŸ”§"
    status:
      - command -v apt >/dev/null 2>&1
    cmds:
      - sudo apt-get update && sudo apt-get install -y mysql-client

  :setup:mysql:linux:yum:
    internal: true
    prefix: "ğŸ”§"
    status:
      - command -v yum >/dev/null 2>&1
    cmds:
      - sudo yum install -y mysql

  :setup:mysql:linux:dnf:
    internal: true
    prefix: "ğŸ”§"
    status:
      - command -v dnf >/dev/null 2>&1
    cmds:
      - sudo dnf install -y mysql

  :setup:mysql:linux:pacman:
    internal: true
    prefix: "ğŸ”§"
    status:
      - command -v pacman >/dev/null 2>&1
    cmds:
      - sudo pacman -S --noconfirm mysql

  :setup:mysql:linux:zypper:
    internal: true
    prefix: "ğŸ”§"
    status:
      - command -v zypper >/dev/null 2>&1
    cmds:
      - sudo zypper install -y mysql-client

  :setup:mysql:windows:
    internal: true
    prefix: "ğŸ”§"
    platforms:
    - windows
    status:
      - command -v mysql >/dev/null 2>&1
    cmds:
      - winget install --id Oracle.MySQL

  :setup:mysql:
    internal: true
    cmds:
      - task: :setup:mysql:macos
      - task: :setup:mysql:linux
      - task: :setup:mysql:windows

  :setup:hurl:macos:
    internal: true
    prefix: "ğŸ”§"
    platforms:
    - darwin
    status:
      - command -v hurl >/dev/null 2>&1
    cmds:
      - brew install hurl

  :setup:hurl:linux:
    internal: true
    prefix: "ğŸ”§"
    platforms:
    - linux
    status:
      - command -v hurl >/dev/null 2>&1
    cmds:
      - curl -LO https://github.com/Orange-OpenSource/hurl/releases/latest/download/hurl-$$(curl -s https://api.github.com/repos/Orange-OpenSource/hurl/releases/latest | grep tag_name | cut -d '"' -f 4)-x86_64-unknown-linux-gnu.tar.gz; \
        tar -xzf hurl-*.tar.gz; \
        sudo mv hurl-*/bin/hurl /usr/local/bin/; \
        rm -rf hurl-*.tar.gz;

  :setup:hurl:windows:
    internal: true
    prefix: "ğŸ”§"
    platforms:
    - windows
    status:
      - command -v hurl >/dev/null 2>&1
    cmds:
      - winget install hurl

  :setup:hurl:
    internal: true
    cmds:
      - task: :setup:hurl:macos
      - task: :setup:hurl:linux
      - task: :setup:hurl:windows

  :setup:shlack:
    internal: true
    prefix: "ğŸ”§"
    status:
      - command -v shlack >/dev/null 2>&1
    cmds:
      - curl --location https://raw.githubusercontent.com/ageha734/shlack/install.sh | bash

  setup:
    desc: "âœ… é–‹ç™ºã«å¿…è¦ãªCLIãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™"
    summary: |
      ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§åˆ©ç”¨ã™ã‚‹å„ç¨®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚
      ãƒ„ãƒ¼ãƒ«ãŒã™ã§ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚
    deps:
      - :setup:mysql
      - :setup:hurl
      - :setup:shlack
    cmds:
      - echo "ğŸ‘ å…¨ã¦ã®ãƒ„ãƒ¼ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"

  # --------------------------------------------------------------------------
  # Development Tasks
  # --------------------------------------------------------------------------
  :run-command:
    internal: true
    silent: true
    vars:
      TARGET: '{{if .SERVICENAME}}{{.SERVICENAME}}{{else}}{{.E2E_TEST_NAME}}{{end}}'
    preconditions:
      - sh: 'if [ -n "{{.SERVICENAME}}" ]; then echo "{{.E2E_TEST_NAME}}" | grep -q -w "{{.SERVICENAME}}"; fi'
        msg: "æŒ‡å®šã•ã‚ŒãŸ '{{.SERVICENAME}}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
    cmds:
      - for:
          var: TARGET
        task: '{{.COMMAND}}'
        vars:
          SERVICENAME: '{{.ITEM}}'

  mod:
    desc: "ğŸ“¦ Goãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¾å­˜é–¢ä¿‚ã‚’æ•´ç†ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™"
    prefix: "ğŸ“¦"
    silent: true
    cmds:
    - go mod tidy
    - go mod download

  build:
    desc: "ğŸ”¨ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™"
    summary: |
      Goãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã—ãŸå¾Œã€`./cmd/main.go`ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦
      `./.target/app`ã«ãƒã‚¤ãƒŠãƒªã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    prefix: "ğŸ”¨"
    deps:
    - mod
    sources:
    - "./**/*.go"
    cmds:
    - go build -o ./.target/app ./cmd/main.go
    generates:
    - "./.target/app"

  dev:
    desc: "âš¡ï¸ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ï¼‰"
    summary: |
      `go run`ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç›´æ¥å®Ÿè¡Œã—ã¾ã™ã€‚
      `watch: true`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€Goãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã™ã‚‹ã¨è‡ªå‹•çš„ã«å†èµ·å‹•ã—ã¾ã™ã€‚
    prefix: "âš¡ï¸"
    watch: true
    sources:
      - "**/*.go"
    cmds:
      - go run ./cmd/main.go

  # --------------------------------------------------------------------------
  # Test & Lint Tasks
  # --------------------------------------------------------------------------
  lint:
    desc: "ğŸ” golangci-lintã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’é™çš„è§£æã—ã¾ã™"
    prefix: "ğŸ”"
    cmds:
    - go tool golangci-lint run ./...

  test:unit:
    desc: "ğŸ”¬ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™"
    summary: "`tenntenn/testtime`ã‚’ä½¿ç”¨ã—ã¦æ™‚åˆ»ã‚’å›ºå®šã—ã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
    prefix: "ğŸ”¬"
    deps:
    - mod
    cmds:
    - go test ./... -overlay=$(go run github.com/tenntenn/testtime/cmd/testtime@latest)

  check:
    desc: "ğŸ›¡ï¸ ãƒªãƒ³ã‚¿ãƒ¼ã¨ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆã€E2Eï¼‰ã‚’å®Ÿè¡Œã—ã¾ã™"
    deps:
    - lint
    - test:unit
    - build

  mysql:
    internal: true
    silent: true
    prefix: "ğŸš€ [{{.SERVICENAME}}]"
    cmds:
    - mysql -u $DATABASE_USER -h $DATABASE_HOST -P $DATABASE_PORT -p$DATABASE_PASSWORD $DATABASE_NAME < '{{.DML}}'
    - hurl --test './e2e/{{.SERVICENAME}}/index.hurl'

  test:e2e:db:
    internal: true
    silent: true
    sources:
    - "./e2e/{{.SERVICENAME}}/*.sql"
    cmds:
    - for: sources
      task: mysql
      vars:
        SERVICENAME: '{{.SERVICENAME}}'
        DML: '{{.ITEM}}'

  test:e2e:single:
    internal: true
    silent: true
    sources:
    - "./e2e/{{.SERVICENAME}}/index.hurl"
    cmds:
    - task: test:e2e:db
      vars:
        SERVICENAME: '{{.SERVICENAME}}'

  test:e2e:
    desc: "ğŸš€ E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆå¼•æ•°ã§ã‚µãƒ¼ãƒ“ã‚¹åã‚’æŒ‡å®šå¯èƒ½ï¼‰"
    summary: |
      ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ãŸå¾Œã€E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
      å¼•æ•°ã§ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚µãƒ¼ãƒ“ã‚¹åã‚’æŒ‡å®šã§ãã¾ã™ã€‚æŒ‡å®šã—ãªã„å ´åˆã¯å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
      å®Ÿè¡Œçµæœã¯Slackã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚

      ä¾‹:
        task test:e2e -- service1  # service1ã®ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
        task test:e2e              # å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    cmds:
    - defer: shlack luke '{{if .EXIT_CODE}}Failed with{{.EXIT_CODE}}!{{else}}Success!{{end}}'
    - task: :run-command
      vars:
        COMMAND: test:e2e:single
        SERVICENAME: '{{.CLI_ARGS}}'
    generates:
    - "./result/{{.SERVICENAME}}.json"
